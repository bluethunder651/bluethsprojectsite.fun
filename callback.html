<!DOCTYPE html>
<html>
<head>
    <title>Connecting to Spotify...</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            text-align: center;
        }
    </style>
</head>
<body>
    <div>
        <h1>ðŸŽµ Music Quiz</h1>
        <p id="status">Completing login...</p>
    </div>

    <script>
        console.log("Callback page loaded");
        
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');
        const storedState = localStorage.getItem('spotify_state');
        
        if (error) {
            console.error("Spotify error:", error);
            document.getElementById('status').innerText = 'Login failed: ' + error;
            setTimeout(() => window.location.href = '/', 3000);
        } 
        else if (!code) {
            console.error("No code in response");
            document.getElementById('status').innerText = 'Invalid response';
            setTimeout(() => window.location.href = '/', 3000);
        }
        else if (state !== storedState) {
            console.error("State mismatch");
            document.getElementById('status').innerText = 'Security error';
            setTimeout(() => window.location.href = '/', 3000);
        }
        else {
            console.log("Authorization code received:", code.substring(0, 10) + "...");
            
            // Exchange code for token
            const codeVerifier = localStorage.getItem('code_verifier');
            const clientId = '73cebf4091ea4699bb90518b005d610b';
            const redirectUri = 'https://bluethsprojectsite.fun/callback.html';
            
            fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: clientId,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: redirectUri,
                    code_verifier: codeVerifier,
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Token response received");
                if (data.access_token) {
                    console.log("Access token obtained");
                    // Store token
                    localStorage.setItem('spotify_token', data.access_token);
                    localStorage.setItem('spotify_refresh_token', data.refresh_token);
                    localStorage.setItem('spotify_token_expiry', Date.now() + (data.expires_in * 1000));
                    
                    // Redirect back to main page
                    window.location.href = 'https://bluethsprojectsite.fun/?login=success';
                } else {
                    console.error("No token in response:", data);
                    document.getElementById('status').innerText = 'Token exchange failed';
                    setTimeout(() => window.location.href = '/', 3000);
                }
            })
            .catch(error => {
                console.error("Token exchange error:", error);
                document.getElementById('status').innerText = 'Connection error';
                setTimeout(() => window.location.href = '/', 3000);
            });
        }
    </script>
</body>
</html>
